<!DOCTYPE html>
<html lang="uk">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–µ—Ä–µ–∫–ª–∞–¥ –∑–∞–∫–ª—è—Ç—å</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
  <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
</head>

<body class="bg-gray-100 text-gray-900 p-6">

  <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 space-y-6">
    <h1 class="text-2xl font-bold">–ü–µ—Ä–µ–∫–ª–∞–¥ –∑–∞–∫–ª—è—Ç—å: <span id="spell-title" class="text-blue-600"></span></h1>

    <!-- Add this dropdown below your <h1> or wherever you want -->
    <div class="mb-4">
      <label for="spell-select" class="block text-sm font-medium mb-1">–û–±–µ—Ä—ñ—Ç—å –∑–∞–∫–ª—è—Ç—Ç—è:</label>
      <select id="spell-select" class="w-full rounded border border-gray-300 p-2"></select>
    </div>


    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium">–ù–∞–∑–≤–∞:</label>
        <div class="flex items-center space-x-">
          <input id="name-rus" class="mt-1 block w-full rounded border-gray-300 pr-8" />
          <span id="check-name-rus" class="text-green-500 hidden">‚úÖ</span>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium">–ù–∞–∑–≤–∞ (–∞–Ω–≥–ª):</label>
        <input id="name-eng" class="mt-1 block w-full rounded border-gray-300" disabled />
      </div>
      <div>
        <label class="block text-sm font-medium">–†—ñ–≤–µ–Ω—å:</label>
        <div class="flex items-center space-x-">
          <input id="level" type="number" class="mt-1 block w-full rounded border-gray-300 pr-8" />
          <span id="check-level" class="text-green-500 hidden">‚úÖ</span>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium">–®–∫–æ–ª–∞:</label>
        <div class="flex items-center space-x-">
          <input id="school" class="mt-1 block w-full rounded border-gray-300 pr-8" />
          <span id="check-school" class="text-green-500 hidden">‚úÖ</span>
        </div>
      </div>
      <div class="col-span-2">
        <label class="block text-sm font-medium">–¢–∏–ø (–¥–æ–¥–∞—Ç–∫–æ–≤–∏–π):</label>
        <div class="flex items-center space-x-">
          <input id="additional-type" class="mt-1 block w-full rounded border-gray-300 pr-8" />
          <span id="check-additional-type" -2 text-green-500 hidden">‚úÖ</span>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ (–º–∞—Ç–µ—Ä—ñ–∞–ª—å–Ω—ñ):</label>
        <div class="flex items-center space-x-">
          <input id="components-m" class="mt-1 block w-full rounded border-gray-300 pr-8" />
          <span id="check-components-m" class2 text-green-500 hidden">‚úÖ</span>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium">–î–∞–ª—å–Ω—ñ—Å—Ç—å:</label>
        <div class="flex items-center space-x-">
          <input id="range" class="mt-1 block w-full rounded border-gray-300 pr-8" />
          <span id="check-range" class="text-green-500 hidden">‚úÖ</span>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium">–ß–∞—Å –Ω–∞–∫–ª–∞–¥–∞–Ω–Ω—è:</label>
        <div class="flex items-center space-x-">
          <input id="duration" class="mt-1 block w-full rounded border-gray-300 pr-8" />
          <span id="check-duration" class="text-green-500 hidden">‚úÖ</span>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium">–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å:</label>
        <div class="flex items-center space-x-">
          <input id="time" class="mt-1 block w-full rounded border-gray-300 pr-8" />
          <span id="check-time" class="text-green-500 hidden">‚úÖ</span>
        </div>
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium mb-2">–û–ø–∏—Å:</label>
      <textarea id="description" class="hidden"></textarea>
    </div>

    <div class="flex justify-between items-center mt-4">
      <button id="prev-btn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded">‚Üê –ù–∞–∑–∞–¥</button>
      <button id="save-btn" class="px-6 py-2 bg-green-500 text-white hover:bg-green-600 rounded">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏
        JSON</button>
      <button id="next-btn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded">–í–ø–µ—Ä–µ–¥ ‚Üí</button>
    </div>

    <p id="load-status" class="text-sm text-gray-600 mt-4"></p>
  </div>

  <script>
    const spellSelect = document.getElementById("spell-select");

    function updateSpellSelect() {
      // Save current selected index to restore after update
      const prevIndex = index;

      spellSelect.innerHTML = ""; // Clear

      spells.forEach((spell, i) => {
        // Check if any _changed field is true
        let changed = false;
        if (spell._changed) {
          changed = Object.values(spell._changed).some(ch => ch === true);
        }

        const option = document.createElement("option");
        option.value = i;
        option.textContent = spell.name?.rus || `–ó–∞–∫–ª—è—Ç—Ç—è ${i + 1}`;
        if (changed) option.textContent += " ‚úÖ";

        spellSelect.appendChild(option);
      });

      // Set selected option to current index
      spellSelect.value = prevIndex;
    }

    // When user selects from dropdown
    spellSelect.addEventListener("change", (e) => {
      const selectedIndex = parseInt(e.target.value);
      if (!isNaN(selectedIndex)) {
        index = selectedIndex;
        loadSpell();
      }
    });

    let spells = [];
    let index = 0;
    let editor;

    const fields = {
      nameRus: document.getElementById("name-rus"),
      nameEng: document.getElementById("name-eng"),
      level: document.getElementById("level"),
      school: document.getElementById("school"),
      additionalType: document.getElementById("additional-type"),
      componentsM: document.getElementById("components-m"),
      range: document.getElementById("range"),
      duration: document.getElementById("duration"),
      time: document.getElementById("time"),
      title: document.getElementById("spell-title")
    };

    const status = document.getElementById("load-status");

    function updateCheckmarks(spell) {
      // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ
      document.querySelectorAll("[id^='check-']").forEach(el => el.classList.add("hidden"));

      // –ü–æ–∫–∞–∑–∞—Ç–∏ –ª–∏—à–µ —Ç—ñ, —â–æ –≤ _changed
      console.dir(spell._changed)
      for (field in spell._changed) {
        if (spell._changed[field]) {
          const el = document.getElementById("check-" + field);
          if (el) el.classList.remove("hidden");
        }
      }
    }


    function loadSpell() {
      const spell = spells[index];
      if (!spell) return;

      fields.nameRus.value = spell.name?.rus || "";
      fields.nameEng.value = spell.name?.eng || "";
      fields.level.value = spell.level ?? "";
      fields.school.value = spell.school || "";
      fields.additionalType.value = spell.additionalType || "";
      fields.componentsM.value = spell.components?.m || "";
      fields.range.value = spell.range || "";
      fields.duration.value = spell.duration || "";
      fields.time.value = spell.time || "";
      editor.value(spell.description || "");
      fields.title.textContent = spell.name?.eng || "???";

      updateCheckmarks(spell);
      updateSpellSelect();
    }


    function saveToFile() {
      const blob = new Blob([JSON.stringify(spells, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "spells.json";
      a.click();
    }

    document.getElementById("prev-btn").onclick = () => {
      if (index > 0) index--;
      loadSpell();
    };

    document.getElementById("next-btn").onclick = () => {
      if (index < spells.length - 1) index++;
      loadSpell();
    };

    document.getElementById("save-btn").onclick = saveToFile;

    // Markdown editor
    editor = new EasyMDE({
      element: document.getElementById("description"),
      spellChecker: false,  // disable spell checking
    });

    editor.codemirror.on("change", () => {
      const current = editor.value();
      const original = spells[index].description || "";
      const changed = current !== original;

      if (!spells[index]._changed) spells[index]._changed = {};
      spells[index]._changed["description"] = changed;

      let icon = document.getElementById("check-description");
      if (!icon) {
        icon = document.createElement("span");
        icon.id = "check-description";
        icon.className = "ml-2 text-green-500";
        icon.textContent = "‚úÖ";
        editor.codemirror.getWrapperElement().parentElement.insertAdjacentElement("beforeend", icon);
      }
      icon.classList.toggle("hidden", !changed);
    });

    // Track changes
    function trackChanges(fieldId, getOriginal, setValue) {
      const input = document.getElementById(fieldId);
      const check = document.getElementById("check-" + fieldId);
      input.addEventListener("input", () => {
        const current = input.value;
        const original = getOriginal();
        const changed = current !== original;

        check.classList.toggle("hidden", !changed);

        if (!spells[index]._changed) spells[index]._changed = {};
        spells[index]._changed[fieldId] = changed;

        if (setValue) setValue(current);
      });
    }

    function setupTracking() {
      trackChanges("name-rus", () => spells[index].name?.rus, val => spells[index].name.rus = val);
      trackChanges("level", () => String(spells[index].level ?? ""), val => spells[index].level = parseInt(val) || 0);
      trackChanges("school", () => spells[index].school || "", val => spells[index].school = val);
      trackChanges("additional-type", () => spells[index].additionalType || "", val => spells[index].additionalType = val);
      trackChanges("components-m", () => spells[index].components?.m || "", val => spells[index].components.m = val);
      trackChanges("range", () => spells[index].range || "", val => spells[index].range = val);
      trackChanges("duration", () => spells[index].duration || "", val => spells[index].duration = val);
      trackChanges("time", () => spells[index].time || "", val => spells[index].time = val);
    }

    // Load spells.json
    async function loadSpells() {
      try {
        status.textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è /data/spells.json...";
        const res = await fetch("/templates/data/spells.json");
        if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ spells.json");
        spells = await res.json();
        if (!Array.isArray(spells)) throw new Error("–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç JSON");
        status.textContent = `–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${spells.length} –∑–∞–∫–ª—è—Ç—å.`;
        loadSpell();
        setupTracking();
      } catch (err) {
        status.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞: " + err.message;
        console.error(err);
      }
    }

    loadSpells();
  </script>
</body>

</html>