<!DOCTYPE html>
<html lang="uk">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–µ—Ä–µ–∫–ª–∞–¥ –∑–∞–∫–ª—è—Ç—å</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-900 p-6">

  <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 space-y-6">
    <h1 class="text-2xl font-bold">–ü–µ—Ä–µ–∫–ª–∞–¥ –∑–∞–∫–ª—è—Ç—å: <span id="spell-title" class="text-blue-600"></span></h1>

    <div class="mb-4">
      <label for="spell-select" class="block text-sm font-medium mb-1">–û–±–µ—Ä—ñ—Ç—å –∑–∞–∫–ª—è—Ç—Ç—è:</label>
      <select id="spell-select" class="w-full rounded border border-gray-300 p-2"></select>
    </div>


    <div class="flex flex-col gap-4">
      <div>
        <label class="block text-sm font-medium">–ù–∞–∑–≤–∞:</label>
        <div class="flex items-center space-x-">
          <input id="name-rus" class="mt-1 block w-full rounded border-gray-300 pr-8" />
          <span id="check-name-rus" class="text-green-500 hidden">‚úÖ</span>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ (–º–∞—Ç–µ—Ä—ñ–∞–ª—å–Ω—ñ):</label>
        <div class="flex items-center">
          <input id="components-m" class="mt-1 block w-full rounded border-gray-300 pr-8" />
          <span id="check-components-m" class="text-green-500 hidden">‚úÖ</span>
        </div>
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium mb-2">–û–ø–∏—Å: <span id="check-description"
          class="top-2 right-2 text-green-500 hidden">‚úÖ</span>
      </label>
      <div class="relative">
        <textarea id="description" class="w-full h-48 rounded border border-gray-300 p-2 resize-y"></textarea>
      </div>
    </div>

    <div class="flex justify-between items-center mt-4">
      <button id="prev-btn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded">‚Üê –ù–∞–∑–∞–¥</button>
      <button id="save-btn" class="px-6 py-2 bg-green-500 text-white hover:bg-green-600 rounded">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏
        JSON</button>
      <button id="next-btn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded">–í–ø–µ—Ä–µ–¥ ‚Üí</button>
    </div>

    <p id="load-status" class="text-sm text-gray-600 mt-4"></p>
  </div>

  <script>
    const spellSelect = document.getElementById("spell-select");
    const descriptionTextarea = document.getElementById("description");

    let spells = [];
    let index = 0;

    const fields = {
      nameRus: document.getElementById("name-rus"),
      componentsM: document.getElementById("components-m"),
      title: document.getElementById("spell-title")
    };

    const status = document.getElementById("load-status");

    function updateCheckmarks(spell) {
      document.querySelectorAll("[id^='check-']").forEach(el => el.classList.add("hidden"));
      for (const field in spell._changed) {
        if (spell._changed[field] === spell[field]) {
          const el = document.getElementById("check-" + field);
          if (el) el.classList.remove("hidden");
        }
      }
    }

    function loadSpell() {
      const spell = spells[index];
      if (!spell) return;

      fields.nameRus.value = spell.name?.rus || "";
      fields.componentsM.value = spell.components?.m || "";
      descriptionTextarea.value = spell.description || "";
      fields.title.textContent = spell.name?.eng || "???";

      updateCheckmarks(spell);
      updateSpellSelect();
    }

    function updateSpellSelect() {
      const prevIndex = index;
      spellSelect.innerHTML = "";

      spells.forEach((spell, i) => {
        let changed = false;
        if (spell._changed) {
          changed = Object.values(spell._changed).some(ch => ch === true);
        }

        const option = document.createElement("option");
        option.value = i;
        option.textContent = spell.name?.rus || `–ó–∞–∫–ª—è—Ç—Ç—è ${i + 1}`;
        if (changed) option.textContent += " ‚úÖ";

        spellSelect.appendChild(option);
      });

      spellSelect.value = prevIndex;
    }

    spellSelect.addEventListener("change", (e) => {
      const selectedIndex = parseInt(e.target.value);
      if (!isNaN(selectedIndex)) {
        index = selectedIndex;
        loadSpell();
      }
    });

    document.getElementById("prev-btn").onclick = () => {
      if (index > 0) index--;
      loadSpell();
    };

    document.getElementById("next-btn").onclick = () => {
      if (index < spells.length - 1) index++;
      loadSpell();
    };

    document.getElementById("save-btn").onclick = () => {
      const blob = new Blob([JSON.stringify(spells, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "spells.json";
      a.click();
    };

    // Track changes
    function trackChanges(fieldId, getOriginal, setValue) {
      const input = document.getElementById(fieldId);
      const check = document.getElementById("check-" + fieldId);
      input.addEventListener("input", () => {
        const current = input.value;
        const original = getOriginal();
        const changed = current !== original;
        
        console.dir({original, current})
        check.classList.toggle("hidden", !changed);
        if (!spells[index]._changed) spells[index]._changed = {};
        spells[index]._changed[fieldId] = current;

        if (setValue) setValue(current);
      });
    }

    function setupTracking() {
      spell_names = spells.map(s => s.name?.rus);
      spell_components_m = spells.map(s => s.components?.m);
      trackChanges("name-rus", () => spell_names[index], val => spells[index].name.rus = val);
      trackChanges("components-m", () => spell_components_m[index] || "", val => spells[index].components.m = val);

      // Track description separately
      spell_descriptions = spells.map(s => s.description)
      descriptionTextarea.addEventListener("input", () => {
        const current = descriptionTextarea.value;
        const original = spell_descriptions[index] || "";
        const changed = current !== original;

        document.getElementById("check-description").classList.toggle("hidden", !changed);
        if (!spells[index]._changed) spells[index]._changed = {};
        spells[index]._changed["description"] = changed;
        spells[index].description = current;
      });
    }

    async function loadSpells() {
      try {
        status.textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è /data/spells.json...";
        const res = await fetch("/templates/data/spells.json");
        if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ spells.json");
        spells = await res.json();
        if (!Array.isArray(spells)) throw new Error("–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç JSON");
        status.textContent = `–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${spells.length} –∑–∞–∫–ª—è—Ç—å.`;
        loadSpell();
        setupTracking();
      } catch (err) {
        status.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞: " + err.message;
        console.error(err);
      }
    }

    loadSpells();
  </script>
</body>

</html>